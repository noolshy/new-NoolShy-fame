// ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
const API_URL = 'http://localhost:3000/api';
const DEFAULT_AVATAR = 'img/default-avatar.png';

// ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
let members = [];
let currentUser = null;
let currentTheme = 'black';
let currentNeonColor = '#808080';
let currentNeonIntensity = 0.5;
let currentNeonSpeed = 5;
let currentAnimatedBg = 'hooks';
let currentBgSpeed = 10;
let currentBgOpacity = 0.5;

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
    initNavigation();
    initAuthSystem();
    loadMembersFromStorage();
    initSnow();
    initSettings();
    initNeonControls();
    initModals();
    initAuthModals();
    initApplyModal();
    loadSavedSettings();
    initDynamicNeon();
    initAllAvatars();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    checkAuth();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    initSearchAndFilter();
});

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–ò–°–ö–ê –ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò ====================
function initSearchAndFilter() {
    // –ü–æ–∏—Å–∫
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            console.log('–ü–æ–∏—Å–∫:', searchTerm);
            searchMembers(searchTerm);
        });
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const category = this.dataset.category;
            console.log('–§–∏–ª—å—Ç—Ä:', category);
            filterMembers(category);
        });
    });
}

// ==================== –°–ò–°–¢–ï–ú–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ====================
function initAuthSystem() {
    // –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    document.getElementById('login-btn')?.addEventListener('click', () => openModal('login-modal'));
    document.getElementById('register-btn')?.addEventListener('click', () => openModal('register-modal'));
    document.getElementById('logout-btn')?.addEventListener('click', logout);
    
    // –ö–Ω–æ–ø–∫–∏ –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é
    document.getElementById('side-login-btn')?.addEventListener('click', () => {
        openModal('login-modal');
        closeSideMenu();
    });
    document.getElementById('side-register-btn')?.addEventListener('click', () => {
        openModal('register-modal');
        closeSideMenu();
    });
    document.getElementById('side-logout-btn')?.addEventListener('click', () => {
        logout();
        closeSideMenu();
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏
    document.getElementById('switch-to-register')?.addEventListener('click', function(e) {
        e.preventDefault();
        closeModal(document.getElementById('login-modal'));
        setTimeout(() => openModal('register-modal'), 300);
    });
    
    document.getElementById('switch-to-login')?.addEventListener('click', function(e) {
        e.preventDefault();
        closeModal(document.getElementById('register-modal'));
        setTimeout(() => openModal('login-modal'), 300);
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º
    document.getElementById('login-submit')?.addEventListener('click', login);
    document.getElementById('register-submit')?.addEventListener('click', register);
    
    // –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    document.getElementById('admin-btn')?.addEventListener('click', openAdminPanel);
    document.getElementById('side-admin-btn')?.addEventListener('click', () => {
        openAdminPanel();
        closeSideMenu();
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    window.addEventListener('message', function(event) {
        if (event.data === 'admin_logout') {
            console.log('–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ –≤—ã—Ö–æ–¥–µ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏');
        }
    });
}

function checkAuth() {
    const userData = localStorage.getItem('fame_user');
    if (userData) {
        try {
            currentUser = JSON.parse(userData);
            updateUIForAuth();
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser.username);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
            localStorage.removeItem('fame_user');
        }
    }
}

function updateUIForAuth() {
    const authLine = document.getElementById('auth-line');
    const userInfoLine = document.getElementById('user-info-line');
    const usernameDisplay = document.getElementById('username-display');
    const sideLoginBtn = document.getElementById('side-login-btn');
    const sideRegisterBtn = document.getElementById('side-register-btn');
    const sideLogoutBtn = document.getElementById('side-logout-btn');
    const adminBtn = document.getElementById('admin-btn');
    const sideAdminBtn = document.getElementById('side-admin-btn');
    
    if (currentUser) {
        // –û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        if (authLine) authLine.style.display = 'none';
        if (userInfoLine) userInfoLine.style.display = 'flex';
        if (usernameDisplay) usernameDisplay.textContent = currentUser.username;
        
        // –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
        if (sideLoginBtn) sideLoginBtn.style.display = 'none';
        if (sideRegisterBtn) sideRegisterBtn.style.display = 'none';
        if (sideLogoutBtn) sideLogoutBtn.style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
        if (adminBtn) {
            adminBtn.style.display = currentUser.isAdmin ? 'block' : 'none';
        }
        if (sideAdminBtn) {
            sideAdminBtn.style.display = currentUser.isAdmin ? 'block' : 'none';
        }
        
        console.log('UI –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    } else {
        // –û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        if (authLine) authLine.style.display = 'flex';
        if (userInfoLine) userInfoLine.style.display = 'none';
        
        // –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
        if (sideLoginBtn) sideLoginBtn.style.display = 'block';
        if (sideRegisterBtn) sideRegisterBtn.style.display = 'block';
        if (sideLogoutBtn) sideLogoutBtn.style.display = 'none';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        if (adminBtn) adminBtn.style.display = 'none';
        if (sideAdminBtn) sideAdminBtn.style.display = 'none';
        
        console.log('UI –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    }
}

function openAdminPanel() {
    if (currentUser?.isAdmin) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        localStorage.setItem('fame_admin_session', 'active');
        window.open('admin-panel/admin.html', '_blank');
    } else {
        alert('–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!');
    }
}

function login() {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    const message = document.getElementById('login-message');
    
    if (!username || !password) {
        showMessage(message, '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ API
    const users = JSON.parse(localStorage.getItem('fame_users') || '[]');
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
        currentUser = {
            id: user.id,
            username: user.username,
            email: user.email,
            isAdmin: user.isAdmin || false,
            createdAt: user.createdAt
        };
        
        localStorage.setItem('fame_user', JSON.stringify(currentUser));
        updateUIForAuth();
        showMessage(message, '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
        setTimeout(() => {
            closeModal(document.getElementById('login-modal'));
            clearForm('login');
        }, 1500);
    } else {
        showMessage(message, '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
    }
}

function register() {
    const username = document.getElementById('register-username').value.trim();
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    const confirm = document.getElementById('register-confirm').value;
    const message = document.getElementById('register-message');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!username || !password || !confirm) {
        showMessage(message, '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    if (username.length < 3 || username.length > 20) {
        showMessage(message, '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }
    
    if (password.length < 6) {
        showMessage(message, '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }
    
    if (password !== confirm) {
        showMessage(message, '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const users = JSON.parse(localStorage.getItem('fame_users') || '[]');
    if (users.some(u => u.username === username)) {
        showMessage(message, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
    }
    
    if (email && users.some(u => u.email === email)) {
        showMessage(message, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const newUser = {
        id: Date.now(),
        username: username,
        email: email || null,
        password: password,
        isAdmin: users.length === 0,
        createdAt: new Date().toISOString()
    };
    
    users.push(newUser);
    localStorage.setItem('fame_users', JSON.stringify(users));
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
    currentUser = {
        id: newUser.id,
        username: newUser.username,
        email: newUser.email,
        isAdmin: newUser.isAdmin,
        createdAt: newUser.createdAt
    };
    
    localStorage.setItem('fame_user', JSON.stringify(currentUser));
    updateUIForAuth();
    showMessage(message, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É.', 'success');
    
    setTimeout(() => {
        closeModal(document.getElementById('register-modal'));
        clearForm('register');
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (newUser.isAdmin) {
            alert('–í—ã –ø–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!');
        }
    }, 1500);
}

function logout() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
        currentUser = null;
        localStorage.removeItem('fame_user');
        localStorage.removeItem('fame_admin_session');
        updateUIForAuth();
        showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
    }
}

function clearForm(formType) {
    if (formType === 'login') {
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        const message = document.getElementById('login-message');
        if (message) message.innerHTML = '';
    } else if (formType === 'register') {
        document.getElementById('register-username').value = '';
        document.getElementById('register-email').value = '';
        document.getElementById('register-password').value = '';
        document.getElementById('register-confirm').value = '';
        const message = document.getElementById('register-message');
        if (message) message.innerHTML = '';
    }
}

// ==================== –°–ò–°–¢–ï–ú–ê –ó–ê–Ø–í–û–ö ====================
function initApplyModal() {
    // –ö–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –∑–∞—è–≤–∫–∏
    document.getElementById('apply-website-btn')?.addEventListener('click', openApplyModal);
    document.getElementById('side-apply-btn')?.addEventListener('click', () => {
        openApplyModal();
        closeSideMenu();
    });
    document.getElementById('faq-apply-btn')?.addEventListener('click', openApplyModal);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞—è–≤–∫–∏
    document.getElementById('apply-submit')?.addEventListener('click', submitApplication);
}

function openApplyModal() {
    if (!currentUser) {
        alert('–î–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
        openModal('login-modal');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const applications = JSON.parse(localStorage.getItem('fame_applications') || '[]');
    const userApplication = applications.find(app => 
        app.userId === currentUser.id && 
        (app.status === 'pending' || app.status === 'review')
    );
    
    if (userApplication) {
        alert(`–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ (—Å—Ç–∞—Ç—É—Å: ${getStatusText(userApplication.status)}).\n–î–æ–∂–¥–∏—Ç–µ—Å—å –µ—ë —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è.`);
        return;
    }
    
    openModal('apply-modal');
}

function submitApplication() {
    if (!currentUser) return;
    
    const nickname = document.getElementById('apply-nickname').value.trim();
    const telegram = document.getElementById('apply-telegram').value.trim();
    const category = document.getElementById('apply-category').value;
    const description = document.getElementById('apply-description').value.trim();
    const links = document.getElementById('apply-links').value.trim();
    const message = document.getElementById('apply-message');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!nickname || !telegram || !category || !description) {
        showMessage(message, '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    if (description.length < 50) {
        showMessage(message, '–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
    const applications = JSON.parse(localStorage.getItem('fame_applications') || '[]');
    const newApplication = {
        id: Date.now(),
        userId: currentUser.id,
        username: currentUser.username,
        nickname: nickname,
        telegram: telegram,
        category: category,
        description: description,
        links: links.split('\n').filter(link => link.trim()),
        status: 'pending',
        createdAt: new Date().toISOString(),
        reviewedAt: null,
        reviewedBy: null,
        rejectionReason: null
    };
    
    applications.push(newApplication);
    localStorage.setItem('fame_applications', JSON.stringify(applications));
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    showAdminNotification(newApplication);
    
    showMessage(message, '–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è.', 'success');
    
    setTimeout(() => {
        closeModal(document.getElementById('apply-modal'));
        document.getElementById('apply-nickname').value = '';
        document.getElementById('apply-telegram').value = '';
        document.getElementById('apply-category').value = '';
        document.getElementById('apply-description').value = '';
        document.getElementById('apply-links').value = '';
        message.innerHTML = '';
    }, 2000);
}

function showAdminNotification(application) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    const notifications = JSON.parse(localStorage.getItem('fame_notifications') || '[]');
    notifications.push({
        id: Date.now(),
        type: 'new_application',
        applicationId: application.id,
        message: `–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ${application.nickname} (${application.username})`,
        createdAt: new Date().toISOString(),
        read: false
    });
    localStorage.setItem('fame_notifications', JSON.stringify(notifications));
}

function getStatusText(status) {
    const statuses = {
        'pending': '–û–∂–∏–¥–∞–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è',
        'review': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
        'accepted': '–ü—Ä–∏–Ω—è—Ç–∞',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'
    };
    return statuses[status] || status;
}

// ==================== –°–ò–°–¢–ï–ú–ê –£–ß–ê–°–¢–ù–ò–ö–û–í ====================
function loadMembersFromStorage() {
    const savedMembers = localStorage.getItem('fame_members');
    if (savedMembers) {
        members = JSON.parse(savedMembers);
    } else {
        // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        members = [
            {
                id: 1,
                nickname: "–∑–æ—Ä—Ñ",
                username: "@tgzorf",
                category: "–í–ª–∞–¥–µ–ª–µ—Ü",
                role: "–í–ª–∞–¥–µ–ª–µ—Ü",
                description: "–í–ª–∞–¥–µ–ª–µ—Ü –∑–æ—Ä—Ñ Fame. –í—Ö–æ–¥ 50 –∑–≤, –≥–∞–ª–æ—á–∫–∞ 30–∑–≤, –∑–∞–∫—Ä–µ–ø 50–∑–≤.",
                avatar: "img/avatar1.png",
                verified: true,
                pinned: true,
                project: "https://t.me/NoolShy",
                telegram: "tgzorf",
                price: "https://noolshy.github.io/market/",
                chat: "https://t.me/NOOLSHY_CHAT",
                market: "https://noolshy.github.io/market/",
                fameList: "https://noolshy.github.io/fame/",
                github: "https://github.com/noolshy",
                joinDate: "2026-01-08",
                activity: "–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è",
                posts: 150,
                followers: 2500,
                priceEntry: "50 –∑–≤",
                priceVerified: "30 –∑–≤",
                pricePinned: "50 –∑–≤",
                details: "–°–æ–∑–¥–∞—Ç–µ–ª—å –∏ –≤–ª–∞–¥–µ–ª–µ—Ü NoolShy Fame. –ó–∞–Ω–∏–º–∞—é—Å—å —Ä–∞–∑–≤–∏—Ç–∏–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –∏ –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π. –û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–æ–≤–æ–¥—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫ –∏ –¥—Ä—É–≥–∏—Ö —É—Å–ª—É–≥.",
                skills: ["–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ú–æ–¥–µ—Ä–∞—Ü–∏—è", "–†–∞–∑–≤–∏—Ç–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞"],
                socials: {
                    telegram: "@tgzorf",
                    project: "https://t.me/NOOLSHY",
                    price: "https://noolshy.github.io/market/"
                }
            }
        ];
        localStorage.setItem('fame_members', JSON.stringify(members));
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    loadMembers();
}

function addMemberFromApplication(application) {
    const newId = members.length > 0 ? Math.max(...members.map(m => m.id)) + 1 : 1;
    
    const newMember = {
        id: newId,
        nickname: application.nickname,
        username: application.telegram,
        category: application.category,
        role: application.category,
        description: application.description,
        avatar: `img/avatar${newId}.png`,
        verified: false,
        pinned: false,
        project: application.links.length > 0 ? application.links[0] : "",
        telegram: application.telegram.replace('@', ''),
        joinDate: new Date().toISOString().split('T')[0],
        activity: "–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è",
        details: application.description,
        skills: ["–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫"],
        socials: {
            telegram: application.telegram
        }
    };
    
    members.push(newMember);
    localStorage.setItem('fame_members', JSON.stringify(members));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    loadMembers();
    
    return newMember;
}

// ==================== –ù–ê–í–ò–ì–ê–¶–ò–Ø –ò –ò–ù–¢–ï–†–§–ï–ô–° ====================
function initNavigation() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏...');
    
    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
    const menuToggle = document.getElementById('menu-toggle');
    const closeMenu = document.getElementById('close-menu');
    const sideMenu = document.getElementById('side-menu');
    
    if (menuToggle) {
        menuToggle.addEventListener('click', openSideMenu);
    }
    
    if (closeMenu) {
        closeMenu.addEventListener('click', closeSideMenu);
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', (event) => {
        if (sideMenu && !sideMenu.contains(event.target) && 
            menuToggle && !menuToggle.contains(event.target) && 
            sideMenu.classList.contains('active')) {
            closeSideMenu();
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    initNavButtons();
    
    console.log('–ù–∞–≤–∏–≥–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
}

function openSideMenu() {
    const sideMenu = document.getElementById('side-menu');
    if (sideMenu) {
        sideMenu.classList.add('active');
        document.body.style.overflow = 'hidden';
        console.log('–ú–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç–æ');
    }
}

function closeSideMenu() {
    const sideMenu = document.getElementById('side-menu');
    if (sideMenu) {
        sideMenu.classList.remove('active');
        document.body.style.overflow = 'auto';
        console.log('–ú–µ–Ω—é –∑–∞–∫—Ä—ã—Ç–æ');
    }
}

function initNavButtons() {
    // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    const navTabs = document.querySelectorAll('.nav-tab[data-section]');
    const menuItems = document.querySelectorAll('.menu-item[data-section]');
    const sections = document.querySelectorAll('.section');
    
    function switchSection(sectionId) {
        console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–µ–∫—Ü–∏—é:', sectionId);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        sections.forEach(section => {
            section.classList.remove('active-section');
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active-section');
            console.log('–°–µ–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞:', sectionId);
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∞—á–∞–ª—É —Å–µ–∫—Ü–∏–∏
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            console.error('–°–µ–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', sectionId);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        navTabs.forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.section === sectionId) {
                tab.classList.add('active');
            }
        });
        
        menuItems.forEach(item => {
            item.classList.remove('active');
            if (item.dataset.section === sectionId) {
                item.classList.add('active');
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    navTabs.forEach(tab => {
        if (tab.dataset.section) {
            tab.addEventListener('click', () => {
                switchSection(tab.dataset.section);
                closeSideMenu();
            });
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
    menuItems.forEach(item => {
        if (item.dataset.section) {
            item.addEventListener('click', () => {
                switchSection(item.dataset.section);
                closeSideMenu();
            });
        }
    });
    
    // –ö–Ω–æ–ø–∫–∏ FAQ
    const faqBtn = document.getElementById('faq-btn');
    const sideFaqBtn = document.getElementById('side-faq-btn');
    
    if (faqBtn) {
        faqBtn.addEventListener('click', () => {
            switchSection('faq-section');
            closeSideMenu();
        });
    }
    
    if (sideFaqBtn) {
        sideFaqBtn.addEventListener('click', () => {
            switchSection('faq-section');
            closeSideMenu();
        });
    }
    
    // –ö–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const settingsBtn = document.getElementById('settings-btn');
    const sideSettingsBtn = document.getElementById('side-settings-btn');
    
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
            openModal('settings-modal');
            closeSideMenu();
        });
    }
    
    if (sideSettingsBtn) {
        sideSettingsBtn.addEventListener('click', () => {
            openModal('settings-modal');
            closeSideMenu();
        });
    }
}

// ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–ß–ê–°–¢–ù–ò–ö–ê–ú–ò ====================
function loadMembers() {
    const container = document.getElementById('members-container');
    if (!container) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    container.innerHTML = '';
    
    if (members.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
        console.log('–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        return;
    }
    
    const sortedMembers = [...members].sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        if (a.verified && !b.verified) return -1;
        if (!a.verified && b.verified) return 1;
        return 0;
    });
    
    sortedMembers.forEach(member => {
        const card = createMemberCard(member);
        container.appendChild(card);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
    document.querySelectorAll('.member-card').forEach(card => {
        card.addEventListener('click', function() {
            const memberId = this.dataset.id;
            console.log('–ö–ª–∏–∫ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É:', memberId);
            showProfile(memberId);
        });
    });
    
    console.log('–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', sortedMembers.length);
}

function createMemberCard(member) {
    const card = document.createElement('div');
    card.className = 'member-card';
    card.dataset.id = member.id;
    card.dataset.category = member.category;
    
    if (member.scam) card.classList.add('scam');
    else if (member.pinned) card.classList.add('pinned');
    if (member.verified && !member.scam) card.classList.add('verified');
  
    const avatarId = `avatar-${member.id}`;
    
    card.innerHTML = `
        <div class="member-avatar" data-initial="${member.nickname.charAt(0).toUpperCase()}">
            <img id="${avatarId}" 
                 src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9IiMzMzMzMzMiPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiLz48dGV4dCB4PSI1MCIgeT0iNTAiIGR5PSIwLjM1ZW0iIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNmZmYiPk48L3RleHQ+PC9zdmc+" 
                 alt="${member.nickname}"
                 loading="lazy">
        </div>
        
        <div class="member-info">
            <h3>${member.nickname} ${member.scam ? '‚ö†Ô∏è' : (member.verified ? '‚úì' : '')}</h3>
            <div class="member-role">${member.role}</div>
            <p class="member-description">${member.description}</p>
            <div class="member-badges">
                ${member.scam ? '‚ö†Ô∏è ' : ''}${member.pinned ? 'üìç ' : ''}${member.verified ? '‚úì ' : ''}${member.category}
            </div>
        </div>
    `;
    
    setTimeout(() => {
        const img = card.querySelector(`#${avatarId}`);
        if (img) {
            loadAvatarWithFallback(img, member.avatar || DEFAULT_AVATAR, member.nickname);
        }
    }, 10);
    
    return card;
}

function filterMembers(category) {
    const cards = document.querySelectorAll('.member-card');
    console.log('–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', category, '–Ω–∞–π–¥–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫:', cards.length);
    
    cards.forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
            card.style.display = 'block';
            setTimeout(() => {
                card.style.opacity = '1';
            }, 10);
        } else {
            card.style.opacity = '0';
            setTimeout(() => {
                card.style.display = 'none';
            }, 300);
        }
    });
}

function searchMembers(term) {
    const cards = document.querySelectorAll('.member-card');
    const activeFilter = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
    
    cards.forEach(card => {
        const nickname = card.querySelector('h3')?.textContent.toLowerCase() || '';
        const description = card.querySelector('.member-description')?.textContent.toLowerCase() || '';
        
        const matchesSearch = nickname.includes(term) || description.includes(term);
        const matchesFilter = activeFilter === 'all' || card.dataset.category === activeFilter;
        
        if (matchesSearch && matchesFilter) {
            card.style.display = 'block';
            setTimeout(() => {
                card.style.opacity = '1';
            }, 10);
        } else {
            card.style.opacity = '0';
            setTimeout(() => {
                card.style.display = 'none';
            }, 300);
        }
    });
}

function showProfile(memberId) {
    const member = members.find(m => m.id == memberId);
    if (!member) {
        console.error('–£—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω:', memberId);
        return;
    }
    
    const container = document.getElementById('profile-content');
    if (!container) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    const joinDate = new Date(member.joinDate);
    const formattedDate = joinDate.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    let badgesHtml = '';
    if (member.scam) {
        badgesHtml += '<span class="badge scam">‚ö†Ô∏è –°–∫–∞–º (–û—Å—Ç–æ—Ä–æ–∂–Ω–æ!)</span>';
    } else if (member.verified) {
        badgesHtml += '<span class="badge verified">‚úì –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span>';
    }
    if (member.pinned) badgesHtml += '<span class="badge pinned">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω</span>';
    badgesHtml += `<span class="badge category">${member.category}</span>`;
    
    let mainButtons = createSocialButton('fab fa-telegram', '–ù–∞–ø–∏—Å–∞—Ç—å –≤ –õ–°', `https://t.me/${member.telegram}`, 'telegram');
    if (member.project) mainButtons += createSocialButton('fas fa-external-link-alt', '–û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª', member.project, 'telegram');
    if (member.chat) mainButtons += createSocialButton('fas fa-comments', '–ß–∞—Ç', member.chat, 'telegram');
    if (member.market) mainButtons += createSocialButton('fas fa-shopping-cart', '–ú–∞—Ä–∫–µ—Ç', member.market);
    if (member.fameList) mainButtons += createSocialButton('fas fa-list', '–§–µ–π–º –ª–∏—Å—Ç', member.fameList);
    if (member.github) mainButtons += createSocialButton('fab fa-github', 'GitHub', member.github);
    
    let extraButtons = '';
    const allPossibleLinks = {
        'price': {icon: 'fas fa-tag', text: '–ü—Ä–∞–π—Å'},
        'priceList': {icon: 'fas fa-tags', text: '–ü—Ä–∞–π—Å-–ª–∏—Å—Ç'},
        'market': {icon: 'fas fa-shopping-cart', text: '–ú–∞—Ä–∫–µ—Ç'},
        'tiktok': {icon: 'fab fa-tiktok', text: 'TikTok'},
        'youtube': {icon: 'fab fa-youtube', text: 'YouTube'},
        'discord': {icon: 'fab fa-discord', text: 'Discord'},
        'vk': {icon: 'fab fa-vk', text: 'VK'},
        'website': {icon: 'fas fa-globe', text: '–°–∞–π—Ç'},
        'forum': {icon: 'fas fa-users', text: '–§–æ—Ä—É–º'}
    };
    
    Object.keys(allPossibleLinks).forEach(key => {
        if (member[key]) {
            extraButtons += createSocialButton(allPossibleLinks[key].icon, allPossibleLinks[key].text, member[key]);
        }
    });
    
    const stats = {
        '–°—Ç–∞—Ç—É—Å': member.role,
        '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è': member.verified ? '‚úì –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' : '‚úó –ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω',
        '–ó–∞–∫—Ä–µ–ø': member.pinned ? 'üìå –í–∫–ª—é—á—ë–Ω' : '‚úó –í—ã–∫–ª—é—á–µ–Ω',
        '–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏': formattedDate,
        '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': member.activity,
        '–ü–æ–¥–ø–∏—Å—á–∏–∫–∏': member.followers,
        'ID': member.id
    };
    
    if (member.priceEntry) stats['–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞'] = member.priceEntry;
    if (member.priceVerified) stats['–¶–µ–Ω–∞ –≥–∞–ª–æ—á–∫–∏'] = member.priceVerified;
    if (member.pricePinned) stats['–¶–µ–Ω–∞ –∑–∞–∫—Ä–µ–ø–∞'] = member.pricePinned;
    
    let statsHtml = '';
    Object.entries(stats).forEach(([label, value]) => {
        if (value) {
            statsHtml += `
                <div class="stat-item">
                    <span class="stat-label">${label}:</span>
                    <span class="stat-value">${value}</span>
                </div>
            `;
        }
    });
    
    const profileAvatarId = `profile-avatar-${member.id}`;
    
    container.innerHTML = `
        <div class="profile-header">
            <div class="profile-avatar" data-initial="${member.nickname.charAt(0).toUpperCase()}">
                <img id="${profileAvatarId}" 
                     src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9IiMzMzMzMzMiPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiLz48dGV4dCB4PSI1MCIgeT0iNTAiIGR5PSIwLjM1ZW0iIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNmZmYiPk48L3RleHQ+PC9zdmc+" 
                     alt="${member.nickname}"
                     loading="eager">
            </div>
            
            <h1 class="profile-title">${member.nickname}</h1>
            <p class="profile-username">${member.username}</p>
            
            <div class="profile-badges">
                ${badgesHtml}
            </div>
            
            <div class="profile-actions">
                ${mainButtons}
                <button class="action-btn" onclick="copyProfileLink('${member.nickname}')">
                    <i class="fas fa-share"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
            </div>
        </div>
        
        <div class="profile-content">
            <div class="profile-description">
                <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                <p>${member.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                
                ${member.details ? `
                    <h3 style="margin-top: 30px;">–î–µ—Ç–∞–ª–∏</h3>
                    <p>${member.details}</p>
                ` : ''}
                
                ${member.skills && member.skills.length > 0 ? `
                    <h3 style="margin-top: 30px;">–ù–∞–≤—ã–∫–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</h3>
                    <p>${member.skills.join(' ‚Ä¢ ')}</p>
                ` : ''}
                
                ${extraButtons ? `
                    <h3 style="margin-top: 30px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h3>
                    <div class="profile-actions">
                        ${extraButtons}
                    </div>
                ` : ''}
            </div>
            
            <div class="profile-stats">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                ${statsHtml}
            </div>
        </div>
    `;
    
    setTimeout(() => {
        const img = document.getElementById(profileAvatarId);
        if (img) {
            loadAvatarWithFallback(img, member.avatar || DEFAULT_AVATAR, member.nickname);
        }
    }, 10);
    
    switchSection('profile-details');
}

// ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
function createSocialButton(icon, text, url, className = '') {
    if (!url) return '';
    return `
        <a href="${url}" class="action-btn ${className}" target="_blank">
            <i class="${icon}"></i> ${text}
        </a>
    `;
}

function loadAvatarWithFallback(imgElement, src, nickname) {
    return new Promise((resolve) => {
        const img = new Image();
        
        img.onload = () => {
            imgElement.src = src;
            imgElement.style.opacity = '1';
            resolve(true);
        };
        
        img.onerror = () => {
            const initial = nickname.charAt(0).toUpperCase();
            const color = generateColorFromNickname(nickname);
            
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
                    <rect width="100" height="100" fill="${color}" rx="50"/>
                    <text x="50" y="50" text-anchor="middle" dy="0.35em" 
                          font-family="Arial, sans-serif" font-size="40" 
                          font-weight="bold" fill="#fff">${initial}</text>
                </svg>
            `;
            
            imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
            imgElement.style.opacity = '1';
            imgElement.classList.add('avatar-fallback');
            resolve(false);
        };
        
        imgElement.style.opacity = '0';
        if (imgElement.parentElement) {
            imgElement.parentElement.classList.add('loading');
        }
        
        setTimeout(() => img.src = src, 100);
        
        setTimeout(() => {
            if (imgElement.parentElement) {
                imgElement.parentElement.classList.remove('loading');
            }
            imgElement.style.opacity = '1';
        }, 2000);
    });
}

function generateColorFromNickname(nickname) {
    const colors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
        '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
        '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#D7BDE2'
    ];
    
    let hash = 0;
    for (let i = 0; i < nickname.length; i++) {
        hash = nickname.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    return colors[Math.abs(hash) % colors.length];
}

function showMessage(element, text, type) {
    if (!element) return;
    
    element.textContent = text;
    element.className = `auth-message ${type}`;
    element.style.display = 'block';
}

function showNotification(text, type = 'info') {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const oldNotification = document.querySelector('.notification');
    if (oldNotification) oldNotification.remove();
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    const icon = type === 'success' ? 'check-circle' : 
                type === 'error' ? 'exclamation-circle' : 'info-circle';
    
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${icon}"></i>
            <span>${text}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => notification.classList.add('show'), 10);
    
    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function switchSection(sectionId) {
    console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏:', sectionId);
    
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active-section');
    });
    
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active-section');
    }
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.section === sectionId) {
            tab.classList.add('active');
        }
    });
}

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ê–í–ê–¢–ê–†–û–í ====================
function initAllAvatars() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤...');
    loadMembers();
}

// ==================== –°–ò–°–¢–ï–ú–ê –ù–ê–°–¢–†–û–ï–ö ====================
function initSnow() {
    const snowContainer = document.querySelector('.snow-container');
    if (!snowContainer) return;
    
    createSnowflakes();
    
    const snowToggle = document.getElementById('snow-effect');
    if (snowToggle) {
        snowToggle.addEventListener('change', function() {
            if (this.checked) {
                snowContainer.style.display = 'block';
                createSnowflakes();
            } else {
                snowContainer.style.display = 'none';
                snowContainer.innerHTML = '';
            }
        });
    }
}

function createSnowflakes() {
    const snowContainer = document.querySelector('.snow-container');
    if (!snowContainer) return;
    
    snowContainer.innerHTML = '';
    
    for (let i = 0; i < 60; i++) {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        
        const size = Math.random() * 4 + 2;
        const startX = Math.random() * 100;
        const duration = Math.random() * 5 + 5;
        const opacity = Math.random() * 0.5 + 0.3;
        
        snowflake.style.width = `${size}px`;
        snowflake.style.height = `${size}px`;
        snowflake.style.left = `${startX}vw`;
        snowflake.style.opacity = opacity;
        snowflake.style.animationDuration = `${duration}s`;
        snowflake.style.animationDelay = `${Math.random() * 5}s`;
        snowflake.style.backgroundColor = `rgba(255, 255, 255, ${opacity})`;
        
        snowContainer.appendChild(snowflake);
    }
}

function initSettings() {
    const settingsTabs = document.querySelectorAll('.settings-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    settingsTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.dataset.tab + '-tab';
            
            settingsTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
        });
    });
    
    const themeOptions = document.querySelectorAll('.theme-option');
    
    themeOptions.forEach(option => {
        option.addEventListener('click', function() {
            const theme = this.dataset.theme;
            
            themeOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            applyTheme(theme);
        });
    });
    
    const bgUpload = document.getElementById('bg-upload');
    const bgPreview = document.getElementById('bg-preview');
    
    if (bgUpload) {
        bgUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    bgPreview.innerHTML = `<img src="${e.target.result}" alt="–§–æ–Ω">`;
                    bgPreview.style.display = 'block';
                    
                    localStorage.setItem('fame_background', e.target.result);
                    document.body.style.backgroundImage = `url(${e.target.result})`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundAttachment = 'fixed';
                    document.body.style.backgroundPosition = 'center';
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    const neonFlowEffect = document.getElementById('neon-flow-effect');
    if (neonFlowEffect) {
        neonFlowEffect.addEventListener('change', function() {
            if (this.checked) {
                initDynamicNeon();
            } else {
                removeNeonFlow();
            }
        });
    }
}

function initNeonControls() {
    const neonColor = document.getElementById('neon-color');
    const neonIntensity = document.getElementById('neon-intensity');
    const neonSpeed = document.getElementById('neon-speed');
    const applyNeonBtn = document.getElementById('apply-neon');
    const intensityValue = document.getElementById('intensity-value');
    const speedValue = document.getElementById('speed-value');
    const colorPreview = document.getElementById('neon-color-preview');
    
    if (neonColor && colorPreview) {
        neonColor.addEventListener('input', function() {
            colorPreview.style.backgroundColor = this.value;
        });
        colorPreview.style.backgroundColor = neonColor.value;
    }
    
    if (neonIntensity && intensityValue) {
        neonIntensity.addEventListener('input', function() {
            intensityValue.textContent = this.value + '%';
        });
        intensityValue.textContent = neonIntensity.value + '%';
    }
    
    if (neonSpeed && speedValue) {
        const speedLabels = {
            1: '–û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ',
            2: '–ú–µ–¥–ª–µ–Ω–Ω–æ',
            3: '–ù–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–æ',
            4: '–ù–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–π',
            5: '–°—Ä–µ–¥–Ω—è—è',
            6: '–í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–π',
            7: '–ë—ã—Å—Ç—Ä–æ',
            8: '–û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ',
            9: '–°—É–ø–µ—Ä –±—ã—Å—Ç—Ä–æ',
            10: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è'
        };
        
        neonSpeed.addEventListener('input', function() {
            speedValue.textContent = speedLabels[this.value] || '–°—Ä–µ–¥–Ω—è—è';
        });
        speedValue.textContent = speedLabels[neonSpeed.value] || '–°—Ä–µ–¥–Ω—è—è';
    }
    
    if (applyNeonBtn) {
        applyNeonBtn.addEventListener('click', function() {
            const color = neonColor.value;
            const intensity = parseInt(neonIntensity.value) / 100;
            const speed = parseInt(neonSpeed.value);
            
            applyNeonSettings(color, intensity, speed);
        });
    }
}

function applyNeonSettings(color, intensity, speed) {
    currentNeonColor = color;
    currentNeonIntensity = intensity;
    currentNeonSpeed = speed;
    
    localStorage.setItem('fame_neon_color', color);
    localStorage.setItem('fame_neon_intensity', intensity);
    localStorage.setItem('fame_neon_speed', speed);
    
    initDynamicNeon();
}

function initDynamicNeon() {
    const oldStyle = document.getElementById('dynamic-neon-style');
    if (oldStyle) oldStyle.remove();
    
    const hex = currentNeonColor;
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    
    const duration = (11 - currentNeonSpeed) + 's';
    
    const style = document.createElement('style');
    style.id = 'dynamic-neon-style';
    
    style.textContent = `
        @keyframes neonFlow {
            0%, 100% { 
                box-shadow: 0 0 ${10 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.8 * currentNeonIntensity}),
                          0 0 ${20 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.6 * currentNeonIntensity}),
                          0 0 ${30 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.4 * currentNeonIntensity}),
                          inset 0 0 ${10 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.5 * currentNeonIntensity}); 
            }
            50% { 
                box-shadow: 0 0 ${15 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.9 * currentNeonIntensity}),
                          0 0 ${25 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.7 * currentNeonIntensity}),
                          0 0 ${35 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.5 * currentNeonIntensity}),
                          inset 0 0 ${15 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.6 * currentNeonIntensity}); 
            }
        }
        
        @keyframes textNeonFlow {
            0%, 100% { 
                text-shadow: 0 0 ${5 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.8 * currentNeonIntensity}),
                           0 0 ${10 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.6 * currentNeonIntensity}); 
            }
            50% { 
                text-shadow: 0 0 ${8 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.9 * currentNeonIntensity}),
                           0 0 ${15 * currentNeonIntensity}px rgba(${r}, ${g}, ${b}, ${0.7 * currentNeonIntensity}); 
            }
        }
        
        .neon-flow {
            animation: neonFlow ${duration} ease-in-out infinite !important;
        }
        
        .text-neon-flow {
            animation: textNeonFlow ${duration} ease-in-out infinite !important;
        }
    `;
    
    document.head.appendChild(style);
    
    const neonFlowEffect = document.getElementById('neon-flow-effect');
    if (neonFlowEffect && neonFlowEffect.checked) {
        applyNeonToElements();
    }
}

function applyNeonToElements() {
    document.querySelectorAll('.member-card').forEach(card => {
        card.classList.add('neon-flow');
    });
    
    document.querySelectorAll('.modal-content').forEach(modal => {
        modal.classList.add('neon-flow');
    });
    
    document.querySelectorAll('.upload-btn').forEach(btn => {
        btn.classList.add('neon-flow');
    });
    
    const profileHeader = document.querySelector('.profile-header');
    if (profileHeader) {
        profileHeader.classList.add('neon-flow');
    }
}

function removeNeonFlow() {
    document.querySelectorAll('.neon-flow').forEach(el => {
        el.classList.remove('neon-flow');
    });
    document.querySelectorAll('.text-neon-flow').forEach(el => {
        el.classList.remove('text-neon-flow');
    });
}

// ==================== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ====================
function initModals() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω...');
    
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            closeModal(this.closest('.modal'));
        });
    });
    
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target);
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            document.querySelectorAll('.modal.active').forEach(modal => {
                closeModal(modal);
            });
            closeSideMenu();
        }
    });
    
    console.log('–ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
}

function initAuthModals() {
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    const switchToRegisterBtn = document.getElementById('switch-to-register');
    const switchToLoginBtn = document.getElementById('switch-to-login');
    
    if (switchToRegisterBtn) {
        switchToRegisterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            closeModal(document.getElementById('login-modal'));
            setTimeout(() => openModal('register-modal'), 300);
        });
    }
    
    if (switchToLoginBtn) {
        switchToLoginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            closeModal(document.getElementById('register-modal'));
            setTimeout(() => openModal('login-modal'), 300);
        });
    }
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ:', modalId);
    } else {
        console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:', modalId);
    }
}

function closeModal(modal) {
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ');
    }
}

function loadSavedSettings() {
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫...');
   
    const savedTheme = localStorage.getItem('fame_theme') || 'black'; 
    if (savedTheme) {
        const themeOption = document.querySelector(`.theme-option[data-theme="${savedTheme}"]`);
        if (themeOption) {
            themeOption.click();
        } else {
            applyTheme('black');
        }
    } else {
        applyTheme('black');
    }
    
    const savedBg = localStorage.getItem('fame_background');
    if (savedBg) {
        document.body.style.backgroundImage = `url(${savedBg})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundAttachment = 'fixed';
        document.body.style.backgroundPosition = 'center';
    }
    
    const savedNeonColor = localStorage.getItem('fame_neon_color') || '#808080';
    const savedNeonIntensity = parseFloat(localStorage.getItem('fame_neon_intensity')) || 0.5;
    const savedNeonSpeed = parseInt(localStorage.getItem('fame_neon_speed')) || 5;
    
    const neonColor = document.getElementById('neon-color');
    const neonIntensity = document.getElementById('neon-intensity');
    const neonSpeed = document.getElementById('neon-speed');
    
    if (neonColor) neonColor.value = savedNeonColor;
    if (neonIntensity) neonIntensity.value = savedNeonIntensity * 100;
    if (neonSpeed) neonSpeed.value = savedNeonSpeed;
    
    applyNeonSettings(savedNeonColor, savedNeonIntensity, savedNeonSpeed);
         
    const savedNeonFlow = localStorage.getItem('fame_neon_flow');
    const neonFlowCheckbox = document.getElementById('neon-flow-effect');
    if (neonFlowCheckbox) {
        if (savedNeonFlow === 'disabled') {
            neonFlowCheckbox.checked = false;
            removeNeonFlow();
        } else {
            neonFlowCheckbox.checked = true;
        }
    }
    
    const savedSnow = localStorage.getItem('fame_snow');
    const snowCheckbox = document.getElementById('snow-effect');
    if (snowCheckbox) {
        if (savedSnow === 'disabled') {
            snowCheckbox.checked = false;
            const snowContainer = document.querySelector('.snow-container');
            if (snowContainer) snowContainer.style.display = 'none';
        } else {
            snowCheckbox.checked = true;
        }
    }
}

function applyTheme(theme) {
    currentTheme = theme;
    
    const themeClasses = ['dark-theme', 'black-theme', 'red-theme', 'red-black-theme', 
                         'red-gray-theme', 'purple-theme', 'blue-theme', 'green-theme', 
                         'orange-theme', 'pink-theme'];
    
    document.body.classList.remove(...themeClasses);
    document.body.classList.add(theme + '-theme');
    
    localStorage.setItem('fame_theme', theme);
}

// ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
window.copyProfileLink = function(username) {
    const link = `https://t.me/NOOLSHY?text=–ü—Ä–æ—Ñ–∏–ª—å%20${encodeURIComponent(username)}%20–Ω–∞%20NoolShy%20Fame`;
    navigator.clipboard.writeText(link).then(() => {
        alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
};

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
document.getElementById('snow-effect')?.addEventListener('change', function() {
    localStorage.setItem('fame_snow', this.checked ? 'enabled' : 'disabled');
});

document.getElementById('neon-flow-effect')?.addEventListener('change', function() {
    localStorage.setItem('fame_neon_flow', this.checked ? 'enabled' : 'disabled');
    if (this.checked) {
        initDynamicNeon();
    } else {
        removeNeonFlow();
    }
});

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(25, 25, 25, 0.95);
        border: 1px solid #333;
        border-radius: 10px;
        padding: 15px 20px;
        color: #fff;
        z-index: 9999;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        max-width: 300px;
        backdrop-filter: blur(10px);
    }
    
    .notification.show {
        transform: translateX(0);
    }
    
    .notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .notification-success {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }
    
    .notification-error {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }
    
    .notification-info {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.1);
    }
    
    .notification-success i {
        color: #28a745;
    }
    
    .notification-error i {
        color: #dc3545;
    }
    
    .notification-info i {
        color: #007bff;
    }
`;
document.head.appendChild(notificationStyle);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
window.addMemberFromApplication = addMemberFromApplication;